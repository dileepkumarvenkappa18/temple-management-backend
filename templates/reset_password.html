<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reset Your Password</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        .spinner {
            border: 3px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top: 3px solid #4f46e5;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen flex items-center justify-center">
    <div class="max-w-md w-full bg-white rounded-lg shadow-lg p-8">
        <h2 class="text-center text-3xl font-extrabold text-gray-900 mb-2">Reset Your Password</h2>
        <p class="text-center text-sm text-gray-600 mb-6">Enter a new password for your account</p>
        
        <!-- Error Message -->
        <div id="errorAlert" class="hidden bg-red-50 border-l-4 border-red-500 p-4 mb-6">
            <div class="flex">
                <div class="flex-shrink-0">
                    <svg class="h-5 w-5 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                    </svg>
                </div>
                <div class="ml-3">
                    <p class="text-sm text-red-700" id="errorMessage">{{ .error }}</p>
                </div>
            </div>
        </div>
        
        <!-- Success Message -->
        <div id="successAlert" class="hidden bg-green-50 border-l-4 border-green-500 p-4 mb-6">
            <div class="flex">
                <div class="flex-shrink-0">
                    <svg class="h-5 w-5 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                    </svg>
                </div>
                <div class="ml-3">
                    <p class="text-sm text-green-700">Password has been reset successfully!</p>
                </div>
            </div>
        </div>
        
        <form id="resetForm" class="space-y-6">
            <div>
                <label for="password" class="block text-sm font-medium text-gray-700 mb-1">New Password</label>
                <input type="password" id="password" name="password" required 
                       class="appearance-none block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                <div id="passwordStrength" class="mt-1 hidden">
                    <div class="h-2 bg-gray-200 rounded-full overflow-hidden">
                        <div id="strengthBar" class="h-full rounded-full transition-all duration-300 bg-red-500" style="width: 0%"></div>
                    </div>
                    <div class="mt-2 grid grid-cols-1 gap-y-1 text-xs">
                        <div id="lengthCheck" class="text-gray-500">✓ At least 8 characters</div>
                        <div id="upperCheck" class="text-gray-500">✓ At least 1 uppercase letter</div>
                        <div id="lowerCheck" class="text-gray-500">✓ At least 1 lowercase letter</div>
                        <div id="numberCheck" class="text-gray-500">✓ At least 1 number</div>
                        <div id="specialCheck" class="text-gray-500">✓ At least 1 special character</div>
                    </div>
                </div>
            </div>
            <div>
                <label for="confirmPassword" class="block text-sm font-medium text-gray-700 mb-1">Confirm New Password</label>
                <input type="password" id="confirmPassword" name="confirmPassword" required 
                       class="appearance-none block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                <p id="passwordMatch" class="mt-1 text-xs text-red-600 hidden">Passwords do not match</p>
            </div>
            <div>
                <button type="submit" id="submitButton" disabled
                        class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 disabled:bg-indigo-300 disabled:cursor-not-allowed">
                    Reset Password
                </button>
            </div>
        </form>
        
        <div id="loginSection" class="hidden mt-6 text-center">
            <a href="/login" class="inline-block w-full py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                Go to Login
            </a>
        </div>
    </div>

    <script>
        // Get token from URL or from template data
        const token = "{{ .token }}" || new URLSearchParams(window.location.search).get('token');
        
        // Show error if provided
        const errorMessage = "{{ .error }}";
        if (errorMessage) {
            document.getElementById('errorAlert').classList.remove('hidden');
            document.getElementById('errorMessage').textContent = errorMessage;
        }
        
        if (!token) {
            document.getElementById('errorAlert').classList.remove('hidden');
            document.getElementById('errorMessage').textContent = 'No reset token provided. Please check your email link.';
            document.getElementById('resetForm').classList.add('hidden');
        }
        
        // Form elements
        const form = document.getElementById('resetForm');
        const passwordInput = document.getElementById('password');
        const confirmInput = document.getElementById('confirmPassword');
        const submitButton = document.getElementById('submitButton');
        const passwordMatch = document.getElementById('passwordMatch');
        const passwordStrength = document.getElementById('passwordStrength');
        const strengthBar = document.getElementById('strengthBar');
        
        // Password strength indicators
        const lengthCheck = document.getElementById('lengthCheck');
        const upperCheck = document.getElementById('upperCheck');
        const lowerCheck = document.getElementById('lowerCheck');
        const numberCheck = document.getElementById('numberCheck');
        const specialCheck = document.getElementById('specialCheck');
        
        // Function to validate password strength
        function checkPasswordStrength(password) {
            const criteria = {
                minLength: password.length >= 8,
                hasUppercase: /[A-Z]/.test(password),
                hasLowercase: /[a-z]/.test(password),
                hasNumber: /\d/.test(password),
                hasSpecialChar: /[!@#$%^&*(),.?":{}|<>]/.test(password)
            };
            
            const score = Object.values(criteria).filter(Boolean).length;
            
            // Update indicators
            lengthCheck.className = criteria.minLength ? 'text-green-600' : 'text-gray-500';
            upperCheck.className = criteria.hasUppercase ? 'text-green-600' : 'text-gray-500';
            lowerCheck.className = criteria.hasLowercase ? 'text-green-600' : 'text-gray-500';
            numberCheck.className = criteria.hasNumber ? 'text-green-600' : 'text-gray-500';
            specialCheck.className = criteria.hasSpecialChar ? 'text-green-600' : 'text-gray-500';
            
            // Update strength bar
            strengthBar.style.width = `${score * 20}%`;
            if (score < 3) {
                strengthBar.className = 'h-full rounded-full transition-all duration-300 bg-red-500';
            } else if (score === 3) {
                strengthBar.className = 'h-full rounded-full transition-all duration-300 bg-yellow-500';
            } else {
                strengthBar.className = 'h-full rounded-full transition-all duration-300 bg-green-500';
            }
            
            return score;
        }
        
        // Event listeners
        passwordInput.addEventListener('input', function() {
            const password = this.value;
            
            if (password) {
                passwordStrength.classList.remove('hidden');
                const score = checkPasswordStrength(password);
                
                // Check password match
                if (confirmInput.value) {
                    if (password === confirmInput.value) {
                        passwordMatch.classList.add('hidden');
                    } else {
                        passwordMatch.classList.remove('hidden');
                    }
                }
                
                // Enable/disable submit button
                submitButton.disabled = !(score >= 3 && password === confirmInput.value);
            } else {
                passwordStrength.classList.add('hidden');
                submitButton.disabled = true;
            }
        });
        
        confirmInput.addEventListener('input', function() {
            const confirmPassword = this.value;
            const password = passwordInput.value;
            
            if (confirmPassword && password) {
                if (password === confirmPassword) {
                    passwordMatch.classList.add('hidden');
                    const score = checkPasswordStrength(password);
                    submitButton.disabled = !(score >= 3);
                } else {
                    passwordMatch.classList.remove('hidden');
                    submitButton.disabled = true;
                }
            } else {
                submitButton.disabled = true;
            }
        });
        
        // Form submission
        form.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const password = passwordInput.value;
            const confirmPassword = confirmInput.value;
            
            if (password !== confirmPassword) {
                passwordMatch.classList.remove('hidden');
                return;
            }
            
            const score = checkPasswordStrength(password);
            if (score < 3) {
                return;
            }
            
            // Show loading state
            submitButton.innerHTML = '<span class="spinner mr-2"></span> Resetting...';
            submitButton.disabled = true;
            
            try {
                const response = await fetch('/api/v1/auth/reset-password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        token: token,
                        newPassword: password  // Match the backend field name
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to reset password');
                }
                
                // Show success message
                document.getElementById('resetForm').classList.add('hidden');
                document.getElementById('successAlert').classList.remove('hidden');
                document.getElementById('loginSection').classList.remove('hidden');
            } catch (error) {
                // Show error message
                document.getElementById('errorAlert').classList.remove('hidden');
                document.getElementById('errorMessage').textContent = error.message;
                
                // Reset button
                submitButton.innerHTML = 'Reset Password';
                submitButton.disabled = false;
            }
        });

        // Initialize
        if (errorMessage) {
            document.getElementById('errorAlert').classList.remove('hidden');
        }
    </script>
</body>
</html>
